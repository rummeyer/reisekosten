package main

import (
	"crypto/rand"
	"fmt"
	"os"
	"regexp"
	"strconv"
	"strings"
	"time"

	"github.com/go-gomail/gomail"
	"github.com/go-pdf/fpdf"
	"github.com/rickar/cal/v2"
	"github.com/rickar/cal/v2/de"
	"golang.org/x/text/language"
	"golang.org/x/text/message"
)

var monthArgRegex = regexp.MustCompile(`^(0?[1-9]|1[0-2])/(20[0-9]{2})$`)

const (
	kmRatePerTrip  = 12.6
	verpflegungRate = 14.0
)

func shortID(length int) string {
	var chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890"
	ll := len(chars)
	b := make([]byte, length)
	rand.Read(b) // generates len(b) random bytes
	for i := 0; i < length; i++ {
		b[i] = chars[int(b[i])%ll]
	}
	return string(b)
}

func reisekostenHeader(year int, month time.Month, dateString, title string) string {
	var b strings.Builder
	b.Grow(256)
	fmt.Fprintf(&b, "                                                               DATUM:   %s\n", dateString)
	fmt.Fprintf(&b, "                                                               BELEGNR: %s\n", shortID(6))
	b.WriteString("\n")
	fmt.Fprintf(&b, "Reisekosten %s %02d/%d\n", title, month, year)
	b.WriteString("===========================================\n\n")
	return b.String()
}

func kilometergeldPosition(dateString string) string {
	var b strings.Builder
	b.Grow(128)
	fmt.Fprintf(&b, "Anreise: %s\nAbreise: %s\n", dateString, dateString)
	b.WriteString("Fahrkosten (42km x 0,30 EUR):            12,60 EUR\n\n")
	return b.String()
}

func customerString() string {
	return "1)\nVon: Origin City, Street (Your Company GmbH)\nNach: Destination City, Street (Client Company GmbH)\nGrund: Projektarbeit\n\n"
}

func verpflegungsmehraufwandPosition(dateString string) string {
	var b strings.Builder
	b.Grow(128)
	fmt.Fprintf(&b, "Anreise: %s, 07:00\nAbreise: %s, 17:00\n", dateString, dateString)
	b.WriteString("Verpflegungsmehraufwand (8h < 24h):      14,-- EUR\n\n")
	return b.String()
}

func createPDF(content, filename string) {
	pdf := fpdf.New("P", "mm", "A4", "")
	pdf.AddPage()
	pdf.SetFont("Courier", "", 11)
	pdf.MultiCell(300, 5, content, "", "", false)
	if err := pdf.OutputFileAndClose(filename); err != nil {
		panic(err)
	}
}

func main() {
	c := cal.NewBusinessCalendar()
	c.Name = "Your Company GmbH"
	c.Description = "Default company calendar"

	// add holidays that the business observes
	c.AddHoliday(
		de.HolidaysBW...,
	)

	matched := len(os.Args) > 1 && monthArgRegex.MatchString(os.Args[1])

	var year int
	var month time.Month

	if matched {
		result := strings.Split(os.Args[1], "/")
		year, _ = strconv.Atoi(result[1])
		m, _ := strconv.Atoi(result[0])
		month = time.Month(m)
	} else {
		y, m, _ := time.Now().Date()
		year = y
		month = m
	}

	var kmBuf, verpBuf strings.Builder
	daysInMonth := time.Date(year, month+1, 0, 0, 0, 0, 0, time.UTC).Day()
	kmBuf.Grow(daysInMonth * 128)
	verpBuf.Grow(daysInMonth * 128)
	var dateString string
	var count int
	for day := 1; day <= daysInMonth; day++ {
		current := time.Date(year, month, day, 0, 0, 0, 0, time.UTC)
		if c.IsWorkday(current) && !(month == 12 && (day == 24 || (day >= 27 && day <= 31))) {
			dateString = fmt.Sprintf("%02d.%02d.%d", day, month, year)
			count++
			kmBuf.WriteString(kilometergeldPosition(dateString))
			verpBuf.WriteString(verpflegungsmehraufwandPosition(dateString))
			if count%10 == 0 {
				kmBuf.WriteString("\n\n")
				verpBuf.WriteString("\n\n")
			}
		}
	}

	customer := customerString()
	kilometerStr := reisekostenHeader(year, month, dateString, "Kilometergelderstattung") + customer + kmBuf.String()
	verpflegungStr := reisekostenHeader(year, month, dateString, "Verpflegungsmehraufwand") + customer + verpBuf.String()

	p := message.NewPrinter(language.German)
	kilometerStr += p.Sprintf("GESAMTBETRAG: %.2f EUR\n", kmRatePerTrip*float64(count))
	verpflegungStr += p.Sprintf("GESAMTBETRAG: %.2f EUR\n", verpflegungRate*float64(count))

	kilometerFilename := fmt.Sprintf("%02d_%d_Reisekosten_Kilometergelderstattung.pdf", month, year)
	createPDF(kilometerStr, kilometerFilename)
	verpflegungFilename := fmt.Sprintf("%02d_%d_Reisekosten_Verpflegungsmehraufwand.pdf", month, year)
	createPDF(verpflegungStr, verpflegungFilename)

	// send pdf
	m := gomail.NewMessage()
	m.SetHeader("From", "user@example.com")
	m.SetHeader("To", "user@example.com")
	//m.SetHeader("Cc", "archive@example.com")
	m.SetHeader("Subject", fmt.Sprintf("Reisekostenabrechnung %02d/%d", month, year))
	m.SetBody("text/html", "Dokumente anbei.<br>")
	m.Attach(kilometerFilename)
	m.Attach(verpflegungFilename)

	d := gomail.NewDialer("smtp.example.com", 587, "smtp-user@example.com", "your-password-here")
	if err := d.DialAndSend(m); err != nil {
		panic(err)
	}

	// remove pdfs
	if err := os.Remove(kilometerFilename); err != nil {
		panic(err)
	}
	if err := os.Remove(verpflegungFilename); err != nil {
		panic(err)
	}
}
